# 工作日志 - 2025-12-23

## 背景
- 本项目最初来源于压缩包/拷贝目录（非 git 仓库）。
- 目标：
  - 将项目纳入 Git 管理并推送到 GitHub。
  - 同步官方 Data Formulator 更新，升级到官方 `0.5.1`。
  - 保留本地中文化与后端改造（中文 UI、中文报告生成等）。
  - 确保可回滚（回档）并可复现构建。

---

## 今日关键结论
- 官方最新版本（tag）为：`0.5.1`。
- 采用的升级策略：
  - 不直接 `merge 0.5.1` 到旧 `main`（因历史无共同祖先），而是：
    - 从官方 tag 创建分支 `upgrade-0.5.1` 作为新基线。
    - 从旧 `main` 迁移本地中文化/后端改造的关键文件。
    - 验证构建通过后，将 `main` 指向升级分支提交并强制更新远端。
- 已完成回滚点准备：
  - 备份分支：`backup-main-before-0.5.1`
  - 备份 tag：`backup-before-0.5.1`

---

## 操作记录（按时间顺序）

### 1) 初始化 git（压缩包/拷贝目录转 git 仓库）
- 在仓库根目录执行：

```bash
git init
git add .
git commit -m "baseline: localized version (from zip)"
```

### 2) 配置远端与推送到 GitHub
- 初次推送时遇到 SSH 22 端口连接问题（`Connection closed ... port 22`）。
- 解决方案：改用 HTTPS remote。

```bash
git remote add origin https://github.com/surdring/DataFormulator.git
git push -u origin main
```

### 3) 添加官方 upstream 并拉取 tags
```bash
git remote add upstream https://github.com/microsoft/data-formulator.git
git fetch upstream
```

### 4) 升级到官方 tag `0.5.1`（核心升级策略）
- 由于旧 `main` 来自压缩包初始化，与官方历史无共同祖先，直接 merge 会报：
  - `fatal: 拒绝合并无关的历史`
- 采用策略：从 tag 直接创建升级分支作为新基线。

```bash
git checkout -b upgrade-0.5.1 0.5.1
```

- 从旧 `main` 迁移本地定制/中文化相关文件（关键文件示例）：
  - 前端中文化：`src/i18n/*`、`src/views/*`（Report/DataThread/Chat 等）
  - 后端报告生成：`py-src/data_formulator/agents/agent_report_gen.py`、`py-src/data_formulator/agent_routes.py`
  - 中文文档与本地维护文档：`使用指南.md`、`升级指南.md`、`安装步骤.md`、工作日志等

（迁移后已在 `upgrade-0.5.1` 上形成提交并推送到远端。）

### 5) 清理敏感文件与生成物（避免提交到仓库）
- 明确不应提交：`.env`、`api-keys.env`、`py-src/*.egg-info/`。
- `.gitignore` 增补：

```gitignore
.env
api-keys.env
py-src/*.egg-info/
```

### 6) 升级分支验证
- 前端构建：

```bash
yarn install
yarn build
```

- Python 编译检查：

```bash
python -m compileall -q py-src/data_formulator
```

### 7) 创建回滚点（备份分支 + tag）并推送
- 在切换 `main` 之前做备份：

```bash
git checkout main
git branch backup-main-before-0.5.1
git tag backup-before-0.5.1
```

- 推送时出现 `refspec 匹配超过一个`，原因是本地存在同名分支与 tag（都叫 `backup-before-0.5.1`）。
- 解决：用显式 refs 推送 tag。

```bash
git push origin refs/tags/backup-before-0.5.1
git push -u origin backup-main-before-0.5.1
```

### 8) 将 `main` 切换到升级后的提交（覆盖式升级）
- 将 `main` 指向 `upgrade-0.5.1` 的最新提交，并强制更新远端 `main`（`--force-with-lease`）：

```bash
git checkout main
git reset --hard upgrade-0.5.1
git push --force-with-lease origin main
```

- 验证结果：
  - `main` 与 `origin/main` 均指向 `b24c81e`（升级提交）。

---

## 回档（回滚）方法

### 回档到升级前（推荐方式：使用备份 tag）
```bash
git checkout main
git reset --hard backup-before-0.5.1
git push --force-with-lease origin main
```

### 回档到升级前（使用备份分支）
```bash
git checkout main
git reset --hard backup-main-before-0.5.1
git push --force-with-lease origin main
```

---

## 待办（后续建议）
- 启动服务做一次端到端手工验证：
  - 中文 UI
  - 数据加载/数据线程
  - 报告生成（中文结构）
  - Chartifact 报告编辑
- 评估是否需要清理远端分支：`upgrade-0.5.1`（可保留一段时间作为对照）。
