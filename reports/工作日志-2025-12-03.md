# 工作日志 - Data Formulator 中文化与报告结构改造

- **日期**：2025-12-03
- **项目**：Data Formulator（本地中文化版本）
- **主要目标**：
  - 完成前端 UI 的全面中文化（技术名词保留英文），消除硬编码英文文案。
  - 确保前端可以正常构建运行。
  - 将后端报告生成 Agent 的提示词改造为中文，并固定报告结构模板。

---

## 一、前端中文化工作

### 1. i18n 字典扩展（`src/i18n/zhCN.ts`）

- **新增 / 完善的主要 key 类型**：
  - 通用按钮与状态：`common.apply`、`common.loading` 等。
  - 概念卡片与派生字段：`concept.form.*`、`concept.dialog.reapply.*`。
  - 数据加载线程与智能清洗：`dataLoading.*`、`messages.dataLoading.*`。
  - 数据线程与图表操作：`dataThread.metadata.*`、`dataThread.agent.*`、`dataThread.chart.tooltip.delete` 等。
  - 报表视图：`report.nav.*`、`report.button.*`、`report.tooltip.*`、`report.compose.*`、`report.error.*` 等。
  - 选择表格视图：`table.tooltip.viewRandom10k`。
  - 其它：可视化视图 vis.*、编码货架 encoding.*、派生数据对话框 derivedData.*、聊天对话框 chatDialog.* 等。

- **风格要求**：
  - 采用自然、专业的简体中文；
  - 界面术语统一，如“报告”、“图表”、“数据源”、“派生数据”；
  - 技术名词（如 provider 名、模型 ID、CSV/JSON/SQL 等）保留英文。

### 2. 视图组件中文化（主要文件）

- `src/views/ReportView.tsx`
  - 顶部导航按钮：
    - `back to explore` → `t('report.nav.backToExplore')`（返回探索视图）。
    - `view reports` → `t('report.nav.viewReports')`（查看报告）。
  - 生成报告相关按钮与 Tooltip：
    - “Delete report / Create Chartifact report / Create Chartifact / Share report as image” → 对应 `report.tooltip.*` 与 `report.button.*`。
  - 已生成报告模式（post）：
    - `create a new report` → `t('report.post.createNew')`。
    - AI 提示文案改为 `t('report.post.aiWarning')`，明确提示“内容由 AI 生成，需业务方审阅”。

- `src/views/ConceptCard.tsx`
  - 概念重应用对话框：标题、代码说明、预览说明全部改为 `concept.dialog.reapply.*`。
  - 概念编辑面板：
    - “derive from fields:” → `t('concept.form.deriveFrom')`。
    - 示例结果 / 代码标签使用 `concept.form.sampleResult.*` 与 `concept.form.codeTitle.*`。
  - 概念相关系统消息使用 `messages.concept.*`，替代英文字符串。

- `src/views/DerivedDataDialog.tsx`
  - 提示“Transformation from ...” → `derivedData.source.prefix`。
  - “Delete all / Save candidate ... as the result” → `derivedData.button.deleteAll / derivedData.button.save`。
  - 对话框标题及底部按钮全部使用 `t()`（含 Cancel / Ok → `common.cancel / common.ok`）。

- `src/views/DataThread.tsx`
  - 图表卡片和缩略图上的“delete chart” Tooltip → `t('dataThread.chart.tooltip.delete')`。
  - 保持与消息删除、表名编辑等已有中文提示风格一致。

- `src/views/DataLoadingThread.tsx`
  - “Stop generation” → `t('dataLoading.button.stop')`。
  - “delete table” → `t('dataLoading.button.deleteTable')`。
  - 统一数据加载相关的 placeholder、错误提示与预览信息，全部走 `dataLoading.*` 和 `messages.dataLoading.*`。

- `src/views/EncodingShelfCard.tsx`
  - “add more base tables for data formulation” Tooltip → `t('encoding.tooltip.addBaseTables')`。

- `src/views/EncodingShelfThread.tsx`
  - 折叠/展开编码面板 Tooltip：
    - `open editor / hide editor` → `t('encoding.editor.open / hide')`。
  - 修复局部变量 `t` 与 i18n 函数 `t()` 的命名冲突，改名为 `tableForThread`。

- `src/views/SelectableDataGrid.tsx`
  - 加载遮罩 “Loading ...” → `t('common.loading')`。
  - 虚拟表随机 10k 行 Tooltip → `t('table.tooltip.viewRandom10k')`。

- `src/views/ChatDialog.tsx`
  - “Dialog with Agents / There is no conversation history yet / You / Assistant / Close” 均替换为 `chatDialog.*` 与 `common.close`。

- 其它视图（`VisualizationView.tsx`、`DBTableManager.tsx`、`ChartRecBox.tsx` 等）
  - 通过 grep 方式查找残留英文字符串，逐一替换为 i18n 文案；
  - 保留必要的技术关键字（如 provider 名称、模型 ID、Chartifact 名称等）。

---

## 二、后端报告生成 Agent 改造

### 1. 位置

- 路由：`py-src/data_formulator/agent_routes.py` 中的 `generate_report_stream`。
- Agent：`py-src/data_formulator/agents/agent_report_gen.py` 中的 `ReportGenAgent`。

### 2. 提示词改造

1. **保留原英文 SYSTEM_PROMPT 与 user_prompt 为注释备份**
   - 没有删除旧英文 prompt，而是全部用注释形式保留，便于未来对比或回滚。

2. **新的中文 SYSTEM_PROMPT**（核心要点）：
   - 角色：资深数据分析师 + 写作助手。
   - 语言：**始终使用简体中文输出**；
   - 格式：使用 Markdown（标题、小节、项目符号等）。
   - 目标：
     - 帮助业务同事快速理解关键发现；
     - 解释趋势、对比、异常；
     - 给出可执行业务建议；
   - 固定结构（强模板化）：
     - 一级标题作为报告标题；
     - 必须包含并按顺序输出以下小节：
       1. 背景与数据范围
       2. 关键发现
       3. 细节分析
       4. 风险与限制
       5. 建议与后续行动
     - 对“关键发现”要求 3–6 条要点；
     - 在“细节分析”中结合图表展开说明；
     - 在“建议与后续行动”中给出面向业务方的具体行动建议。

3. **新的中文 user_prompt**（请求级约束）：
   - 再次强调使用简体中文 + Markdown；
   - 指明 `style` 对应的写作风格；
   - 明确正文结构要求：
     - 一个一级标题；
     - 依次为上述 5 个小节；
     - 各小节职责说明与输出要求。

### 3. 调用链保持不变

- 前端仍通过 `fetch(getUrls().GENERATE_REPORT_STREAM, ...)` 调用后端；
- 后端仍使用 `ReportGenAgent.stream(...)` 以流式方式返回文本；
- 仅修改提示词内容，不改变接口签名和数据格式。

---

## 三、构建与运行

1. **前端构建**
   - 在项目根目录执行：
     - `yarn install`（如首次拉取或依赖更新时）
     - `yarn build`
   - 本次工作中已成功执行 `yarn build`，构建通过。

2. **后端依赖与启动（建议）**
   - Python 依赖：
     - 建议使用虚拟环境：`python -m venv venv && source venv/bin/activate`
     - 安装依赖：`pip install -r requirements.txt`
   - 启动本地服务：
     - `./local_server.sh`
   - 浏览器访问：
     - <http://localhost:5000>

---

## 四、后续可选工作

- 根据实际业务场景，进一步微调中文文案（特别是 ReportView 中的报告风格文案）。
- 如需支持中英双语切换，可在现有 `i18n` 架构上新增 `enUS.ts`，并做运行时语言切换（当前版本未实现）。
- 定期跟进官方仓库更新，按“升级指南.md” 操作合并上游改动，保持功能同步。

---

## 五、当前 TODO 状态

- 所有与前端中文化和构建相关的内部 TODO（loc-1 ~ loc-6）均已完成：
  - 全局英文 UI 扫描与替换 ✅
  - ReportView 细节文案补齐 ✅
  - TableSelectionView、DataThread、DataLoading、ChatDialog 等组件中文化 ✅
  - 整体英文关键字抽查 ✅
  - 前端构建验证 ✅
  - 后端报告生成中文化与结构模板 ✅

当前无未完成的本地化相关任务。"}},{
