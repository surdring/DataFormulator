# 升级指南 - 与官方 Data Formulator 仓库保持同步

本指南说明：当官方仓库（如 `microsoft/data-formulator`）有更新时，如何在**保留本地中文化与后端改造**的前提下，安全地拉取并合并上游改动。

> 以下以本地当前仓库所在目录 `/home/zhengxueen/workspace/data-formulator` 为例，假设你已在此目录运行过 `git init` 或从 Git 托管平台克隆了项目。

---

## 1. 准备工作

### 1.1 确认当前分支干净

```bash
cd /home/zhengxueen/workspace/data-formulator

git status
```

- 如果有未提交改动，建议先：
  - 将当前工作提交：
    ```bash
    git add .
    git commit -m "chore: 中文化与报告生成改造"
    ```
  - 或使用临时分支备份（见下文）。

### 1.2 添加官方上游仓库（只需执行一次）

```bash
git remote add upstream https://github.com/microsoft/data-formulator.git
```

- 如果已经添加过，可以用 `git remote -v` 查看：
  - `origin`：你自己的远程（如个人 fork）；
  - `upstream`：官方仓库。

---

## 2. 备份当前中文化版本

> 强烈建议在每次大版本合并前创建一个备份分支，便于回滚或对比。

```bash
cd /home/zhengxueen/workspace/data-formulator

git checkout main   # 或你实际工作的主分支名

git pull origin main   # 确保本地 main 与远程同步

git checkout -b backup-chinese-localization-$(date +%Y%m%d)
```

可选：同时打一个 tag（更适合长期复用脚本进行“自动恢复中文化”）：

```bash
# 例如：在升级到 0.5.2 之前
git tag backup-before-0.5.2
git push origin backup-before-0.5.2
```

- 该分支会保留当前所有中文化和后端改造的状态。
- 如遇到严重冲突或问题，可以随时回到该分支继续开发。

---

## 3. 拉取官方最新代码

1. 从官方仓库获取最新提交：

   ```bash
   git fetch upstream
   ```

2. 切回主分支并合并上游：

   ```bash
   git checkout main
   git merge upstream/main
   ```

   > 如果你更熟悉 rebase，也可以：
   >
   > ```bash
   > git checkout main
   > git rebase upstream/main
   > ```

3. 解决合并冲突（如有），然后：

   ```bash
   git add <有冲突的文件>
   git commit
   ```

---

## 4. 常见冲突文件与处理建议

由于本地做了中文化和后端 prompt 改造，以下文件在合并上游时**最容易产生冲突**：

1. **前端翻译与视图**
   - `src/i18n/zhCN.ts`
   - `src/views/ReportView.tsx`
   - `src/views/ConceptCard.tsx`
   - `src/views/DataThread.tsx`
   - `src/views/DataLoadingThread.tsx`
   - `src/views/EncodingShelfCard.tsx`
   - `src/views/EncodingShelfThread.tsx`
   - `src/views/SelectableDataGrid.tsx`
   - `src/views/ChatDialog.tsx`

   处理思路：
   - **保留本地中文化的 key 和 `t()` 调用**；
   - 将上游新增的字段、属性或逻辑合并进来；
   - 对于上游新增的 UI 文案，按当前约定再补充到 `zhCN.ts` 中，并改为使用 `t()`。

2. **后端报告生成 Agent**
   - `py-src/data_formulator/agents/agent_report_gen.py`
   - `py-src/data_formulator/agent_routes.py`

   处理思路：
   - 保留本地的中文 `SYSTEM_PROMPT` 和 `user_prompt`，并继续保持英文版本为注释备用；
   - 注意上游如对 `ReportGenAgent` 接口、返回结构做了变更，需要根据官方逻辑适配；
   - 若上游增加了新的参数（如额外的 style、语言字段等），在前端和后端一并补齐。

### 4.1 实用对比方法

- 对单个文件使用对比：

  ```bash
  git diff upstream/main -- path/to/file
  ```

- 对整体查看本地与上游差异：

  ```bash
  git diff upstream/main
  ```

- 需要图形化对比时，可以使用 IDE 的 Git 比较工具（如 VS Code 的“Compare with Selected”）。

---

## 5. 合并后验证

在合并并解决所有冲突后，建议做以下检查：

### 5.1 安装 / 更新依赖

- 前端：

  ```bash
  cd /home/zhengxueen/workspace/data-formulator
  yarn install
  ```

- 后端（建议在虚拟环境中）：

  ```bash
  pip install -r requirements.txt
  ```

  > 如果官方新增了依赖，会在 `requirements.txt` 或相关文件中体现。

### 5.2 构建前端

```bash
yarn build
```

- 确认构建无报错；
- 如出现类型或语法错误，优先查看最近合并有冲突的文件（尤其是 `src/views` 与 `src/i18n/zhCN.ts`）。

### 5.3 启动后端并手工验证

```bash
./local_server.sh
```

- 在浏览器访问 <http://localhost:5000>：
  - 检查首页、数据加载、数据线程、编码货架、报表视图等是否仍为中文界面；
  - 测试一次报告生成，确认生成内容为简体中文，并符合“背景与数据范围 / 关键发现 / 细节分析 / 风险与限制 / 建议与后续行动”结构；
  - 如有新功能（官方新增），检查对应界面是否需要新增中文文案 key。

### 5.4 升级后自动恢复中文化（推荐）

如果你确认“升级前界面是中文、升级后变英文”，通常说明前端中文化被上游代码覆盖。

本仓库提供脚本用于在升级后**自动找回被覆盖的 `t('...')` 调用**：

- 脚本：`tools/restore_i18n_from_backup.py`
- 原理：对比一个参考 ref（建议为升级前备份分支/备份 tag）与当前 `HEAD`，把参考 ref 中的小块 `t('key')` 用法恢复到当前版本。

1) 先预览（不改文件）：

```bash
python3 tools/restore_i18n_from_backup.py --ref backup-main-before-0.5.1 --dry-run
```

2) 确认无误后应用（会改文件）：

```bash
python3 tools/restore_i18n_from_backup.py --ref backup-main-before-0.5.1 --apply
```

3) 再重新构建并验证：

```bash
yarn build
./local_server.sh
```

说明：

- 为了长期复用，建议你每次升级前都打一个 tag（例如 `backup-before-0.5.2`），升级后使用 `--ref backup-before-0.5.2`。
- 该脚本会跳过过大的代码块替换以降低误改风险；若升级跨度很大，可能需要分目录执行（例如只处理 `src/views`、`src/app`）。

---

## 6. 提交并推送更新

在本地验证通过后，将合并后的代码提交并推送到自己的远程仓库：

```bash
git add .

# 建议在提交信息中说明本次是同步官方更新
git commit -m "chore: merge upstream main and keep Chinese localization"

git push origin main
```

如后续发现问题，可以：

- 回退到备份分支 `backup-chinese-localization-YYYYMMDD` 继续开发；
- 或使用 `git revert` 撤销某次有问题的合并提交。

---

## 7. 升级时的注意事项

- **先备份，后合并**：不要在只有一个分支的情况下直接合并上游大版本，容易回滚困难。
- **保持中文化策略一致**：
  - 所有新出现的英文 UI 文案，第一时间加到 `zhCN.ts` 并通过 `t()` 使用；
  - 新出现的报表或智能体功能，如需中文输出，也应在后端增加相应中文 prompt。
- **遇到中文化被覆盖时先用脚本恢复**：
  - 优先运行 `tools/restore_i18n_from_backup.py`（先 `--dry-run`，再 `--apply`）；
  - 再做 `yarn build` 与启动验证，避免手工逐个文件找回。
- **小步快跑**：官方如果更新较频繁，可以定期（如每月）拉一次上游，避免一次性差异过大、冲突复杂。

通过以上流程，可以在**尽量少打断现有中文化体验**的前提下，持续跟进官方 Data Formulator 的新特性和 bugfix。
