# Data Formulator 安装与使用指南

> 本文档由《安装步骤.md》《使用指南.md》整理合并而来，作为本仓库的**唯一主文档**。

---

## 1. 工具概览

**Data Formulator** 是 Microsoft Research 推出的交互式数据分析与可视化工具：

- 通过 **AI agent** 帮你完成数据转换、图表推荐和报告生成；
- 支持 **多种数据源**：结构化文件、截图、文本、网站、数据库等；
- 允许你在 **拖拽 UI** 与 **自然语言指令** 之间自由切换；
- 使用“数据线程（Data Threads）”追踪探索路径，支持回溯与分支。

---

## 2. 系统要求

- Python ≥ 3.9（推荐 **Python 3.11**）
- Node.js
- Yarn

补充说明：

- 如果你使用 **Python 3.12**，在安装第三方依赖（尤其是云厂商 SDK、数据库驱动、镜像源不完整时）可能更容易遇到兼容性/安装失败问题。
- 若你在 `pip install -r requirements.txt` 阶段遇到无法解决的报错，优先尝试换用 Python 3.11 的虚拟环境再安装依赖。

---

## 3. 获取代码 / 安装方式

你有两种常见使用方式：

### 3.1 方式 A：仅体验（pip 安装）

适合只想本机体验功能、不改源码的场景：

```bash
pip install data_formulator
python -m data_formulator
```

运行后浏览器会自动打开：<http://localhost:5000>

### 3.2 方式 B：本地开发/二次定制（本仓库源码）

适合需要改源码或二次定制的场景（你当前就是这种）。

---

## 4. 安装步骤（本仓库源码）

### 4.1 创建并激活 Python 虚拟环境

```bash
python3 -m venv venv
source venv/bin/activate
python -m pip install --upgrade pip
```

### 4.2 安装 Python 依赖

```bash
pip install -r requirements.txt
```

如果安装过程中出现以下情况（你刚才已遇到类似问题）：

- `SSLError(SSLEOFError ...)` / “There was a problem confirming the ssl certificate”
- `ERROR: Could not find a version that satisfies the requirement pymongo (from versions: none)`

建议按以下顺序排查：

1) 临时切换为官方 PyPI 源（优先用于排查镜像问题）

```bash
pip install -r requirements.txt -i https://pypi.org/simple
```

2) 如果你必须使用国内镜像，但遇到 SSL 异常，可尝试更换镜像源（不同网络环境下稳定性差异较大）

```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

3) 如果仍然出现“找不到 pymongo/某些包”的情况，通常不是你机器缺东西，而是镜像源不完整或网络/证书链异常。
   - 优先回到 `https://pypi.org/simple` 完成依赖安装。

4) 说明：`requirements.txt` 中包含“外部数据加载器（External data loaders）”相关依赖（例如 BigQuery、MongoDB 等）。
   - 如果你不使用这些外部连接器，你仍然可以先完成“最小可运行安装”（见本文档第 12.5 节），后续按需补装。

#### 配置阿里云镜像源（可选，国内推荐）

临时使用：

```bash
pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com
```

永久配置：

```bash
mkdir -p ~/.pip
echo -e "[global]\nindex-url = https://mirrors.aliyun.com/pypi/simple/\ntrusted-host = mirrors.aliyun.com" > ~/.pip/pip.conf
```

### 4.3 安装前端依赖

```bash
# 如未安装 yarn
npm install -g yarn

# 安装前端依赖
yarn
```

---

## 5. 环境变量与模型配置

### 5.1 基础配置文件

本项目通过根目录下的以下文件读取配置：

- `.env`（可选）
- `api-keys.env`（模型/Provider 配置，推荐使用本地文件）

初始化方式：

```bash
cp .env.template .env
cp api-keys.env.template api-keys.env
```

> 注意：不要将 `.env` 与 `api-keys.env` 提交到 git（仓库已在 `.gitignore` 忽略）。

### 5.2 使用本地部署的 LLM（llama.cpp，OpenAI 兼容接口）

Data Formulator 不直接启动或管理 `llama.cpp`，只要你的本地模型通过 HTTP 暴露为 **OpenAI 兼容接口**即可。

1) 启动 `llama-server`（示例，按你实际路径调整）：

```bash
/home/zhengxueen/workspace/llama.cpp/build-hip/bin/llama-server \
  -m /mnt/ssd/models/gpt-oss-20b-mxfp4.gguf \
  -c 0 --n-gpu-layers -1 --jinja \
  --host 0.0.0.0 --port 8080 --alias gpt-oss-20b
```

2) 编辑 `api-keys.env`（示例）：

```env
OPENAI_ENABLED=true
OPENAI_API_BASE=http://localhost:8080/v1
OPENAI_API_KEY=dummy-key
OPENAI_MODELS=gpt-oss-20b
```

3) 启动应用后，在右上角模型配置对话框：

- provider 选择 `openai`
- model 选择 `gpt-oss-20b`
- 点击 **Test**，状态为 `Ready` 即可

### 5.3 通过 Ollama 使用本地模型（可选）

1) 安装 Ollama：<https://ollama.com/download>

2) 下载模型：

```bash
ollama pull llama3
```

3) 编辑 `api-keys.env`：

```env
OLLAMA_ENABLED=true
OLLAMA_API_BASE=http://localhost:11434
OLLAMA_MODELS=llama3:latest
```

4) 启动应用后，在模型配置对话框中：

- provider 选择 `ollama`
- 选择你配置的模型
- 点击 **Test**

---

## 6. 运行应用

### 6.1 开发模式（推荐）

```bash
# 确保已激活虚拟环境
source venv/bin/activate

# 如前端有修改或首次运行，先构建静态资源
yarn build

# 启动
./local_server.sh
```

如果提示权限不足：

```bash
chmod +x local_server.sh
./local_server.sh

# 或者
bash local_server.sh
```

浏览器访问：<http://localhost:5000>

### 6.2 生产模式（可选）

1) 构建前端：

```bash
yarn build
```

2) 构建 Python 包：

```bash
pip install build
python -m build
```

3) 安装并运行：

```bash
pip install dist/data_formulator-*.whl
data_formulator
```

---

## 7. 界面与核心概念

- **数据表（Tables）**：导入或连接得到的数据。
- **派生字段/概念（Derived Concepts）**：通过 AI 生成的新字段（例如“利润率”“同比增长”）。
- **探索线程（Exploration Threads）/ 数据线程（Data Threads）**：记录每一步转换与图表，支持回溯与分支。
- **Agent 模式**：给出探索目标，让 AI 多轮规划并执行分析。

---

## 8. 数据加载方式

常见数据来源：

1) **上传本地文件**：`csv` / `tsv` / `xlsx`
2) **从截图/文本提取表格**：适合报告截图、PDF 表格等
3) **从网站或非结构化文本抓取数据**：提供 URL 或数据片段
4) **外部数据库 / 数据湖连接**：见 `py-src/data_formulator/data_loader`
5) **大数据场景**：DuckDB 集成按需取子集

---

## 9. 与 AI 的几种协作模式（Level 1–4）

### 9.1 Level 1：完全手动（拖拽 UI）

- 直接把字段拖到 X/Y/颜色/大小/过滤等槽位

### 9.2 Level 2：NL + UI 混合

- 在编码区指定部分字段
- 再用自然语言描述图表/转换需求

### 9.3 Level 3：图表推荐与探索建议

- 直接描述你的问题，让 agent 给出多种分析视角

### 9.4 Level 4：Agent 模式，多轮自动探索

- 给出更高层目标，由 agent 规划多步分析

---

## 10. 模型配置与管理

- 主要由 `api-keys.env` 控制 provider 与模型列表（OpenAI/Azure/Ollama/本地 OpenAI 兼容/Anthropic 等）
- 前端右上角模型配置对话框支持：
  - 选择模型并分配到不同任务槽位
  - Test 检测可用性（`Ready` 才建议用于正式分析）

---

## 11. 从探索到报告

- 在报告界面选择你想展示的图表
- 选择报告风格（如博客/管理层摘要等）
- 生成后可复制、导出、或截图分享

---

## 12. 常见问题与排查

### 12.1 打开 <http://localhost:5000> 报 500 / 找不到 index.html

常见原因：前端静态资源未构建。

- 执行：`yarn build`
- 再重启：`./local_server.sh`

### 12.2 日志中大量 “Error testing ... model ...”

- 不用的 provider 请在 `api-keys.env` 中设为 `*_ENABLED=false`
- 检查 `API_BASE`、`API_KEY`、`MODELS` 与实际服务一致

### 12.3 llama.cpp curl 能通，但前端仍显示模型不可用

- 检查：
  - `OPENAI_ENABLED=true`
  - `OPENAI_API_BASE` 与端口一致（如 `http://localhost:8080/v1`）
  - `OPENAI_MODELS` 与请求 `model` 名称一致

### 12.4 pyodbc 安装失败

Ubuntu/Debian：

```bash
sudo apt-get install unixodbc-dev
```

CentOS/RHEL：

```bash
sudo yum install unixODBC-devel
```

### 12.5 pip 安装依赖失败（SSL / 镜像不全 / pymongo 找不到）

现象示例：

- `SSLError(SSLEOFError ...)`（使用镜像源时 SSL 握手异常）
- `No matching distribution found for pymongo`（镜像源不包含该包或网络/证书异常导致索引不可用）

推荐处理方式：

1) 先使用官方 PyPI 完成安装（用于确认“依赖本身可安装”）：

```bash
pip install -r requirements.txt -i https://pypi.org/simple
```

2) 如果你确实只想先跑起来，不使用外部数据连接器（BigQuery/MongoDB/Kusto 等），可以按“最小可运行安装”先启动：

```bash
pip install \
  jupyter pandas numpy flask flask-cors openai python-dotenv vega_datasets \
  litellm duckdb vl-convert-python backoff beautifulsoup4 scikit-learn \
  -e .
```

然后再按需补装外部数据加载器依赖（可选）：

```bash
pip install azure-identity azure-kusto-data azure-keyvault-secrets azure-storage-blob
pip install google-cloud-bigquery google-auth db-dtypes
pip install boto3 pymysql pyodbc pymongo
```

补充说明：

- 如果你使用 Python 3.12 且依赖安装持续异常，建议改用 Python 3.11 的 venv 重试。

---

## 13. 进一步阅读

- 官方仓库：<https://github.com/microsoft/data-formulator>
- 本项目内文档：
  - `README.md`
  - `DEVELOPMENT.md`
  - `升级指南.md`
  - `py-src/data_formulator/data_loader/README.md`
